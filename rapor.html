<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Cetak Rapor Peserta Didik</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">

<style>
@media print {
  .no-print { display:none !important; }
  body { background:#fff; }
}
.page {
  width:210mm;
  min-height:297mm;
  padding:20mm;
  box-sizing:border-box;
  page-break-after:always;
  font-family:"Times New Roman", Times, serif;
  color:#000;
  background:#fff;
}
.page.hide { display:none; }

.header { display:flex; gap:14px; align-items:center; }
.header img { width:80px; }

.judul {
  text-align:center;
  font-weight:bold;
  font-size:14pt;
  margin:12px 0 16px;
}

.identitas {
  width:100%;
  border-collapse:collapse;
  margin-bottom:14px;
}
.identitas td { padding:4px 2px; }
.identitas td:nth-child(1){width:150px;}
.identitas td:nth-child(2){width:10px;}
.identitas td:nth-child(3){font-weight:bold;}

.section { margin-top:14px; }
.section h3 {
  margin-bottom:6px;
  border-bottom:1px solid #000;
}

.mapel { margin-bottom:10px; }
.mapel p { margin:4px 0 0; text-align:justify; }

.table {
  width:100%;
  border-collapse:collapse;
}
.table th,.table td {
  border:1px solid #000;
  padding:6px;
}

.ttd {
  width:100%;
  margin-top:50px;
  text-align:center;
}
.ttd td {
  padding-top:70px;
  vertical-align:top;
}
</style>
</head>

<body>

<!-- ================= CONTROL PANEL ================= -->
<div class="no-print" style="padding:10px; background:#020617; color:#fff;">
  <b>Siswa:</b>
  <button onclick="prevSiswa()">‚óÄ</button>
  <select id="pilihSiswa" onchange="renderSingle()"></select>
  <button onclick="nextSiswa()">‚ñ∂</button>

  &nbsp; | &nbsp;
  <b>Preview:</b>
  <button onclick="showPage(1)">Hal 1</button>
  <button onclick="showPage(2)">Hal 2</button>
  <button onclick="showPage(3)">Hal 3</button>
  <button onclick="showAll()">Semua</button>

  &nbsp; | &nbsp;
  <button onclick="exportSiswa()">üìÑ PDF Siswa</button>
  <button onclick="exportKelas()">üìö PDF Kelas</button>

  &nbsp;
  <a href="index.html" style="color:#93c5fd;">‚Üê Kembali</a>
</div>

<div id="output"></div>

<script src="storage.js"></script>
<script>
let idxSiswa = 0;

/* ================= DESKRIPSI ================= */
function deskripsiCP(nis,mapel){
  const d=getData("asesmenCP").filter(x=>x.nis===nis&&x.mapel===mapel);
  if(!d.length) return "-";
  d.sort((a,b)=>b.nilai-a.nilai);
  return `Ananda menunjukkan penguasaan yang sangat baik dalam ${d[0].deskripsi.toLowerCase()}, namun masih perlu pendampingan dalam ${d[d.length-1].deskripsi.toLowerCase()}.`;
}

function deskripsiKokurikuler(pred){
  if(pred==="Sangat Baik")
    return "Ananda menunjukkan keterlibatan yang sangat aktif dan bertanggung jawab dalam kegiatan kokurikuler.";
  if(pred==="Baik")
    return "Ananda menunjukkan keterlibatan yang baik dalam kegiatan kokurikuler.";
  if(pred==="Cukup")
    return "Ananda menunjukkan keterlibatan yang cukup dalam kegiatan kokurikuler.";
  return "Ananda perlu pendampingan lebih lanjut dalam kegiatan kokurikuler.";
}

function catatanGuru(nis){
  const c=getData("catatanGuru").find(x=>x.nis===nis);
  return c ? `Ananda ${c.deskripsi}` :
    "Ananda menunjukkan perkembangan sikap dan kebiasaan belajar yang baik selama semester ini.";
}

function formatTanggal(tgl){
  if(!tgl) return "-";
  return new Date(tgl).toLocaleDateString("id-ID",
    {day:"numeric",month:"long",year:"numeric"});
}

/* ================= RENDER ================= */
function renderRapor(list){
  const sekolah=getData("dataSekolah")[0]||{};
  const nilai=getData("asesmenNilai");
  const mapel=getData("dataMapel");
  const kok=getData("kokurikuler");
  const hadir=getData("kehadiran");

  let html="";
  list.forEach(s=>{

/* ---------- PAGE 1 ---------- */
html+=`
<div class="page p1">
  <div class="header">
    <img src="img/logo.png">
    <div>
      <b>${sekolah.namaSekolah||""}</b><br>
      ${sekolah.alamatSekolah||""}
    </div>
  </div>

  <div class="judul">LAPORAN HASIL BELAJAR PESERTA DIDIK</div>

  <table class="identitas">
    <tr><td>Nama Peserta Didik</td><td>:</td><td>${s.nama}</td></tr>
    <tr><td>NIS / NISN</td><td>:</td><td>${s.nis} / ${s.nisn||"-"}</td></tr>
    <tr><td>Kelas</td><td>:</td><td>${sekolah.kelas||""}</td></tr>
    <tr><td>Semester</td><td>:</td><td>${sekolah.semester||""}</td></tr>
    <tr><td>Tahun Pelajaran</td><td>:</td><td>${sekolah.tahunPelajaran||""}</td></tr>
  </table>

  <div class="section"><h3>A. Muatan Pelajaran</h3>`;
mapel.filter(m=>m.kelompok==="Muatan Pelajaran"&&m.status==="aktif")
.forEach(m=>{
 const n=nilai.find(x=>x.nis===s.nis&&x.mapel===m.kode);
 if(!n) return;
 html+=`
  <div class="mapel">
    <b>${m.nama}</b> ‚Äî Nilai <b>${Math.round(n.nilai_akhir)}</b>
    <p>${deskripsiCP(s.nis,m.kode)}</p>
  </div>`;
});
html+=`</div></div>`;

/* ---------- PAGE 2 ---------- */
html+=`
<div class="page p2">
  <div class="section"><h3>B. Muatan Lokal</h3>`;
mapel.filter(m=>m.kelompok==="Muatan Lokal"&&m.status==="aktif")
.forEach(m=>{
 const n=nilai.find(x=>x.nis===s.nis&&x.mapel===m.kode);
 if(!n) return;
 html+=`<div class="mapel"><b>${m.nama}</b> ‚Äî ${Math.round(n.nilai_akhir)}
 <p>${deskripsiCP(s.nis,m.kode)}</p></div>`;
});
html+=`</div>
<div class="section"><h3>C. Mata Pelajaran Pilihan</h3>`;
mapel.filter(m=>m.kelompok==="Mapel Pilihan"&&m.status==="aktif")
.forEach(m=>{
 const n=nilai.find(x=>x.nis===s.nis&&x.mapel===m.kode);
 if(!n) return;
 html+=`<div class="mapel"><b>${m.nama}</b> ‚Äî ${Math.round(n.nilai_akhir)}
 <p>${deskripsiCP(s.nis,m.kode)}</p></div>`;
});
html+=`</div></div>`;

/* ---------- PAGE 3 ---------- */
const k=kok.find(x=>x.nis===s.nis)||{};
const h=hadir.find(x=>x.nis===s.nis)||{};
html+=`
<div class="page p3">
  <div class="section">
    <h3>D. Kokurikuler</h3>
    <table class="table">
      <tr><th>Tema</th><th>Kegiatan</th><th>Predikat</th><th>Deskripsi</th></tr>
      <tr>
        <td>${k.tema||"-"}</td>
        <td>${k.kegiatan||"-"}</td>
        <td align="center">${k.predikat||"-"}</td>
        <td>${k.predikat?deskripsiKokurikuler(k.predikat):"-"}</td>
      </tr>
    </table>
  </div>

  <div class="section">
    <h3>E. Ketidakhadiran</h3>
    <table class="table">
      <tr><th>Sakit</th><th>Izin</th><th>Alfa</th></tr>
      <tr>
        <td align="center">${h.sakit||0}</td>
        <td align="center">${h.izin||0}</td>
        <td align="center">${h.alfa||0}</td>
      </tr>
    </table>
  </div>

  <div class="section">
    <h3>F. Catatan Wali Kelas</h3>
    <p>${catatanGuru(s.nis)}</p>
  </div>

  <table class="ttd">
    <tr>
      <td>Orang Tua/Wali<br><br>....................</td>
      <td>
        ${sekolah.kabupaten||""}, ${formatTanggal(sekolah.tanggalRapor)}<br>
        Wali Kelas<br><br>
        <b>${sekolah.waliKelas||""}</b><br>
        NIP. ${sekolah.nipWali||"-"}
      </td>
      <td>
        Kepala Sekolah<br><br>
        <b>${sekolah.kepalaSekolah||""}</b><br>
        NIP. ${sekolah.nipKepala||"-"}
      </td>
    </tr>
  </table>
</div>`;
  });

  document.getElementById("output").innerHTML=html;
}

/* CONTROL */
function showPage(n){
  document.querySelectorAll(".page").forEach(p=>p.classList.add("hide"));
  document.querySelectorAll(".p"+n).forEach(p=>p.classList.remove("hide"));
}
function showAll(){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("hide"));
}
function renderSingle(){
  const s=getData("dataSiswa");
  idxSiswa=pilihSiswa.selectedIndex;
  renderRapor([s[idxSiswa]]);
  showAll();
}
function renderKelas(){
  renderRapor(getData("dataSiswa"));
  showAll();
}
function prevSiswa(){ if(idxSiswa>0){idxSiswa--;pilihSiswa.selectedIndex=idxSiswa;renderSingle();}}
function nextSiswa(){
 const s=getData("dataSiswa");
 if(idxSiswa<s.length-1){idxSiswa++;pilihSiswa.selectedIndex=idxSiswa;renderSingle();}
}
function exportSiswa(){
 const s=getData("dataSiswa")[idxSiswa];
 document.title=`Rapor_${s.nama}_${s.nis}`;
 window.print();
}
function exportKelas(){
 document.title="Rapor_Kelas";
 renderKelas();
 window.print();
}

/* INIT */
document.addEventListener("DOMContentLoaded",()=>{
 const sel=document.getElementById("pilihSiswa");
 getData("dataSiswa").forEach(s=>sel.innerHTML+=`<option>${s.nama}</option>`);
 renderSingle();
});
</script>

</body>
</html>